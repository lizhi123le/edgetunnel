name: 混淆并创建 GitHub 发行版
on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 */9 * * *'

jobs:
  obfuscate-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      # ==================== 正确三方合并（最终修复版） ====================
      - name: 检查上游仓库更新并同步备份文件
        id: check-update
        run: |
          set -euo pipefail

          WORKER_URL="https://raw.githubusercontent.com/cmliu/edgetunnel/main/_worker.js"
          TOML_URL="https://raw.githubusercontent.com/cmliu/edgetunnel/main/wrangler.toml"

          BACKUP_FILE="_worker.js.backup"
          BASE_FILE="_worker.js.upstream"
          WORKER_HASH_FILE=".worker_hash"

          TOML_FILE="wrangler.toml"
          TOML_HASH_FILE=".toml_hash"

          curl -fsSL -o temp_worker.js "$WORKER_URL"
          curl -fsSL -o temp_toml.toml "$TOML_URL"

          NEW_WORKER_HASH=$(sha256sum temp_worker.js | cut -d' ' -f1)
          OLD_WORKER_HASH=$(cat "$WORKER_HASH_FILE" 2>/dev/null || echo "")

          NEW_TOML_HASH=$(sha256sum temp_toml.toml | cut -d' ' -f1)
          OLD_TOML_HASH=$(cat "$TOML_HASH_FILE" 2>/dev/null || echo "")

          HAS_UPDATE="false"

          # ========== worker.js 三方合并 ==========
          if [ "$NEW_WORKER_HASH" != "$OLD_WORKER_HASH" ]; then
            echo "上游 _worker.js 有更新"

            # 首次运行：初始化 base + backup
            if [ ! -f "$BASE_FILE" ]; then
              echo "首次运行，初始化基线与备份"
              cp temp_worker.js "$BASE_FILE"
              cp temp_worker.js "$BACKUP_FILE"
            else
              echo "执行三方合并：local vs base vs upstream"

              cp "$BACKUP_FILE" local_worker.js
              cp "$BASE_FILE" base_worker.js
              cp temp_worker.js upstream_worker.js

              git merge-file local_worker.js base_worker.js upstream_worker.js || true

              echo "更新本地备份与基线"
              mv -f local_worker.js "$BACKUP_FILE"
              mv -f temp_worker.js "$BASE_FILE"
            fi

            echo "$NEW_WORKER_HASH" > "$WORKER_HASH_FILE"
            HAS_UPDATE="true"
          else
            rm -f temp_worker.js
          fi

          # ========== wrangler.toml 覆盖 ==========
          if [ "$NEW_TOML_HASH" != "$OLD_TOML_HASH" ]; then
            mv -f temp_toml.toml "$TOML_FILE"
            echo "$NEW_TOML_HASH" > "$TOML_HASH_FILE"
            HAS_UPDATE="true"
          else
            rm -f temp_toml.toml
          fi

          echo "has_update=$HAS_UPDATE" >> $GITHUB_OUTPUT

      # ==================== 计算版本号 ====================
      - name: 计算版本号
        id: generate-version
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          LOCAL_HASH=$(sha256sum _worker.js.backup | cut -d' ' -f1)
          VERSION="${LOCAL_HASH:0:12}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ==================== 混淆流程 ====================
      - name: Set up Node.js
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'

      - name: Install dependencies
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          npm install
          sudo apt-get update -qq
          sudo apt-get install -y jq zip

      - name: 创建 _worker_temp.js
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        run: cp _worker.js.backup _worker_temp.js

      - name: 混淆代码
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          rm -f _worker.js
          npm run build -- --input _worker_temp.js --output _worker.js

      - name: 压缩为 worker.zip
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        run: zip worker.zip _worker.js

      - name: 提交并推送更改
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 关键修复：仅在文件存在时 add
          git add _worker.js _worker.js.backup wrangler.toml .worker_hash .toml_hash worker.zip
          if [ -f "_worker.js.upstream" ]; then
            git add _worker.js.upstream
          fi

          if git diff --cached --quiet; then
            echo "无文件变更，跳过提交"
            exit 0
          fi

          VERSION="${{ steps.generate-version.outputs.version }}"
          git commit -m "自动更新：混淆版 + 备份（版本 $VERSION）"


      # ==================== 创建 Release ====================
      - name: 创建或覆盖 Release
        if: steps.check-update.outputs.has_update == 'true' || github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.generate-version.outputs.version }}"
          gh release delete "$VERSION" -y || true
          gh release create "$VERSION" worker.zip _worker.js.backup -t "$VERSION" -n "自动构建版本"

